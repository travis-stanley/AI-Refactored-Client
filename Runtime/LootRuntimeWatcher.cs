// <auto-generated>
//   This file is part of AI-Refactored, an open-source project focused on realistic AI behavior in Escape from Tarkov.
//   Licensed under the MIT License. See LICENSE in the repository root for more information.
//
//   THIS FILE IS SYSTEMATICALLY MANAGED.
//   Please follow strict StyleCop, ReSharper, and AI-Refactored code standards for all modifications.
// </auto-generated>

namespace AIRefactored.Runtime
{
    using System;
    using System.Collections.Generic;
    using AIRefactored.AI.Core;
    using AIRefactored.Bootstrap;
    using AIRefactored.Core;
    using BepInEx.Logging;
    using UnityEngine;

    /// <summary>
    /// Detects dynamic runtime loot additions (e.g. player death drops, mission rewards).
    /// Triggers a delayed loot registry refresh on authoritative hosts.
    /// </summary>
    public sealed class LootRuntimeWatcher : IAIWorldSystemBootstrapper
    {
        #region Constants

        private const float RefreshDelaySeconds = 0.15f;

        #endregion

        #region Static Fields

        private static readonly ManualLogSource Logger = Plugin.LoggerInstance;
        private static readonly HashSet<int> RegisteredInstanceIds = new HashSet<int>();

        private static float _nextAllowedRefreshTime = -1f;
        private static bool _isQueued;

        #endregion

        #region Lifecycle

        /// <inheritdoc />
        public void Initialize()
        {
            try
            {
                Reset();
                Logger.LogDebug("[LootRuntimeWatcher] ✅ Initialized.");
            }
            catch (Exception ex)
            {
                Logger.LogError("[LootRuntimeWatcher] ❌ Initialize error: " + ex);
            }
        }

        /// <inheritdoc />
        public void Tick(float deltaTime)
        {
            try
            {
                if (!_isQueued || Time.time < _nextAllowedRefreshTime)
                {
                    return;
                }

                if (!GameWorldHandler.IsReady() || !GameWorldHandler.IsHost)
                {
                    return;
                }

                _isQueued = false;
                GameWorldHandler.RefreshLootRegistry();
                Logger.LogDebug("[LootRuntimeWatcher] ✅ Loot registry refreshed.");
            }
            catch (Exception ex)
            {
                Logger.LogError("[LootRuntimeWatcher] ❌ Tick error: " + ex);
            }
        }

        /// <inheritdoc />
        public void OnRaidEnd()
        {
            try
            {
                Reset();
                Logger.LogDebug("[LootRuntimeWatcher] 🧹 Reset after raid.");
            }
            catch (Exception ex)
            {
                Logger.LogError("[LootRuntimeWatcher] ❌ OnRaidEnd error: " + ex);
            }
        }

        /// <inheritdoc />
        public bool IsReady()
        {
            return true;
        }

        /// <inheritdoc />
        public WorldPhase RequiredPhase()
        {
            return WorldPhase.WorldReady;
        }

        #endregion

        #region Public API

        /// <summary>
        /// Queues a delayed refresh of the loot registry.
        /// </summary>
        public static void TriggerQueuedRefresh()
        {
            if (_isQueued || !GameWorldHandler.IsReady() || !GameWorldHandler.IsHost)
            {
                return;
            }

            _nextAllowedRefreshTime = Time.time + RefreshDelaySeconds;
            _isQueued = true;
        }

        /// <summary>
        /// Forces an immediate loot registry refresh.
        /// </summary>
        public static void TriggerManualRefresh()
        {
            if (!GameWorldHandler.IsReady() || !GameWorldHandler.IsHost)
            {
                return;
            }

            _isQueued = false;
            GameWorldHandler.RefreshLootRegistry();
            Logger.LogDebug("[LootRuntimeWatcher] 🔁 Manual loot registry refresh triggered.");
        }

        /// <summary>
        /// Registers a GameObject for loot tracking. Triggers a refresh if new.
        /// </summary>
        /// <param name="go">GameObject representing loot.</param>
        public static void Register(GameObject go)
        {
            if (go == null)
            {
                return;
            }

            int id = go.GetInstanceID();
            if (RegisteredInstanceIds.Add(id))
            {
                TriggerQueuedRefresh();
            }
        }

        /// <summary>
        /// Unregisters a GameObject from loot tracking.
        /// </summary>
        /// <param name="go">GameObject previously registered as loot.</param>
        public static void Unregister(GameObject go)
        {
            if (go == null)
            {
                return;
            }

            int id = go.GetInstanceID();
            if (RegisteredInstanceIds.Remove(id))
            {
                try
                {
                    Logger.LogDebug("[LootRuntimeWatcher] Unregistered loot object: " + go.name);
                }
                catch
                {
                    // Logger may be disposed during teardown
                }
            }
        }

        /// <summary>
        /// Resets internal state for new raids.
        /// </summary>
        public static void Reset()
        {
            RegisteredInstanceIds.Clear();
            _isQueued = false;
            _nextAllowedRefreshTime = -1f;

            try
            {
                Logger.LogDebug("[LootRuntimeWatcher] 🔄 Reset complete.");
            }
            catch
            {
                // Logger may be null during teardown
            }
        }

        #endregion
    }
}
