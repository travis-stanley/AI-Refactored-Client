// <auto-generated>
//   This file is part of AI-Refactored, an open-source project focused on realistic AI behavior in Escape from Tarkov.
//   Licensed under the MIT License. See LICENSE in the repository root for more information.
//
//   THIS FILE IS SYSTEMATICALLY MANAGED.
//   Failures in AIRefactored logic must always trigger safe fallback to EFT base AI, never break the stack.
//   Please follow strict StyleCop, ReSharper, and AI-Refactored code standards for all modifications.
// </auto-generated>

namespace AIRefactored.AI.Perception
{
    using System.Collections.Generic;
    using AIRefactored.AI.Core;
    using AIRefactored.AI.Helpers;
    using AIRefactored.Core;
    using AIRefactored.Pools;
    using EFT;
    using UnityEngine;

    /// <summary>
    /// Provides vision profiles per <see cref="WildSpawnType"/>, with optional personality scaling.
    /// Used to simulate flash/flare/suppression resistance and light reactivity.
    /// </summary>
    public static class BotVisionProfiles
    {
        #region Static Defaults

        private static readonly BotVisionProfile DefaultProfile = BotVisionProfile.CreateDefault();
        private static readonly Dictionary<WildSpawnType, BotVisionProfile> Profiles = InitializeProfiles();

        #endregion

        #region Public API

        /// <summary>
        /// Retrieves the bot vision profile, applying role-based defaults and optional personality blending.
        /// Always returns a non-null, fully valid profile.
        /// </summary>
        public static BotVisionProfile Get(Player bot)
        {
            if (!EFTPlayerUtil.IsValid(bot))
                return DefaultProfile;

            WildSpawnType role = WildSpawnType.assault;
            Profile profile = bot.Profile;

            if (profile?.Info?.Settings != null)
                role = profile.Info.Settings.Role;

            if (!Profiles.TryGetValue(role, out BotVisionProfile baseProfile) || baseProfile == null)
                baseProfile = DefaultProfile;

            BotComponentCache cache = BotCacheUtility.GetCache(bot);
            if (cache == null)
                return baseProfile;

            var aiOwner = cache.AIRefactoredBotOwner;
            if (aiOwner == null)
                return baseProfile;

            BotPersonalityProfile personality = aiOwner.PersonalityProfile;
            if (personality == null)
                return baseProfile;

            // Final blended profile — non-null, clamped, and scaled per role + personality
            return new BotVisionProfile
            {
                AdaptationSpeed = Mathf.Clamp(baseProfile.AdaptationSpeed + (1f - personality.Caution) * 0.5f, 0.5f, 3f),
                MaxBlindness = Mathf.Clamp(baseProfile.MaxBlindness + (1f - personality.RiskTolerance) * 0.4f, 0.5f, 2f),
                LightSensitivity = Mathf.Clamp(baseProfile.LightSensitivity + personality.Caution * 0.5f, 0.3f, 2f),
                AggressionResponse = Mathf.Clamp(baseProfile.AggressionResponse + personality.AggressionLevel * 0.5f, 0.5f, 3f),
                ClarityRecoverySpeed = Mathf.Clamp(baseProfile.ClarityRecoverySpeed + (1f - personality.Caution) * 0.3f, 0.1f, 1f)
            };
        }

        #endregion

        #region Profile Setup

        private static Dictionary<WildSpawnType, BotVisionProfile> InitializeProfiles()
        {
            var temp = TempDictionaryPool.Rent<WildSpawnType, BotVisionProfile>();
            var result = new Dictionary<WildSpawnType, BotVisionProfile>(32);

            void Add(WildSpawnType type, float a, float l, float ar, float mb, float cr) =>
                temp[type] = new BotVisionProfile
                {
                    AdaptationSpeed = a,
                    LightSensitivity = l,
                    AggressionResponse = ar,
                    MaxBlindness = mb,
                    ClarityRecoverySpeed = cr
                };

            Add(WildSpawnType.assault, 0.75f, 1.2f, 0.9f, 1.1f, 0.35f);
            Add(WildSpawnType.cursedAssault, 0.7f, 1.4f, 1.0f, 1.2f, 0.3f);
            Add(WildSpawnType.marksman, 1.0f, 1.0f, 1.1f, 1.1f, 0.4f);
            Add(WildSpawnType.sectantPriest, 0.5f, 1.5f, 0.5f, 1.3f, 0.25f);
            Add(WildSpawnType.sectantWarrior, 0.6f, 1.5f, 0.8f, 1.3f, 0.3f);
            Add(WildSpawnType.pmcBot, 2.0f, 0.85f, 1.4f, 0.8f, 0.5f);
            Add(WildSpawnType.exUsec, 1.9f, 0.85f, 1.4f, 0.85f, 0.45f);
            Add(WildSpawnType.bossBully, 1.3f, 1.0f, 2.0f, 1.0f, 0.55f);
            Add(WildSpawnType.followerBully, 1.1f, 1.0f, 1.7f, 1.0f, 0.45f);
            Add(WildSpawnType.bossKilla, 1.6f, 0.7f, 2.5f, 0.9f, 0.5f);
            Add(WildSpawnType.bossTagilla, 1.5f, 0.9f, 2.2f, 0.95f, 0.4f);
            Add(WildSpawnType.followerTagilla, 1.2f, 1.0f, 1.6f, 1.0f, 0.45f);
            Add(WildSpawnType.bossSanitar, 1.4f, 0.95f, 2.0f, 0.95f, 0.5f);
            Add(WildSpawnType.followerSanitar, 1.3f, 1.0f, 1.7f, 1.0f, 0.45f);
            Add(WildSpawnType.bossGluhar, 1.4f, 1.0f, 2.2f, 1.0f, 0.55f);
            Add(WildSpawnType.followerGluharAssault, 1.2f, 1.0f, 1.5f, 1.0f, 0.5f);
            Add(WildSpawnType.followerGluharScout, 1.3f, 1.0f, 1.7f, 1.0f, 0.5f);
            Add(WildSpawnType.followerGluharSecurity, 1.1f, 1.1f, 1.6f, 1.0f, 0.45f);
            Add(WildSpawnType.followerGluharSnipe, 1.0f, 1.1f, 1.4f, 1.0f, 0.4f);
            Add(WildSpawnType.bossKnight, 1.5f, 1.0f, 2.0f, 0.9f, 0.5f);
            Add(WildSpawnType.followerBigPipe, 1.2f, 1.0f, 1.8f, 0.95f, 0.45f);
            Add(WildSpawnType.followerBirdEye, 1.2f, 1.1f, 1.6f, 1.0f, 0.5f);
            Add(WildSpawnType.gifter, 1.0f, 0.8f, 0.5f, 1.1f, 0.3f);
            Add(WildSpawnType.arenaFighter, 1.3f, 1.0f, 1.5f, 0.95f, 0.45f);

            foreach (var kvp in temp)
                result[kvp.Key] = kvp.Value;

            TempDictionaryPool.Return(temp);
            return result;
        }

        #endregion
    }
}
