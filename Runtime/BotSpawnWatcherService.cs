// <auto-generated>
//   This file is part of AI-Refactored, an open-source project focused on realistic AI behavior in Escape from Tarkov.
//   Licensed under the MIT License. See LICENSE in the repository root for more information.
//
//   THIS FILE IS SYSTEMATICALLY MANAGED.
//   Failures in AIRefactored logic must always trigger safe fallback to EFT base AI.
// </auto-generated>

namespace AIRefactored.Runtime
{
	using System;
	using System.Collections.Generic;
	using AIRefactored.AI.Core;
	using AIRefactored.AI.Navigation;
	using AIRefactored.AI.Threads;
	using AIRefactored.Bootstrap;
	using AIRefactored.Core;
	using BepInEx.Logging;
	using Comfort.Common;
	using EFT;
	using UnityEngine;

	/// <summary>
	/// Static bot spawn tracker. Injects brains for new bots without using MonoBehaviours.
	/// Called externally on update by WorldBootstrapper or BotWorkScheduler.
	/// </summary>
	public sealed class BotSpawnWatcherService : IAIWorldSystemBootstrapper
	{
		#region Constants

		private const float PollInterval = 1.5f;

		#endregion

		#region Fields

		private static readonly HashSet<int> SeenBotIds = new HashSet<int>();
		private static readonly ManualLogSource Logger = Plugin.LoggerInstance;

		private static float _nextPollTime = -1f;
		private static bool _hasWarnedInvalid;

		#endregion

		#region Lifecycle

		/// <inheritdoc />
		public void Initialize()
		{
			try
			{
				Reset();
				LogDebug("[BotSpawnWatcher] ✅ Initialized.");
			}
			catch (Exception ex)
			{
				LogError("[BotSpawnWatcher] ❌ Initialize failed: " + ex);
			}
		}

		/// <inheritdoc />
		public void OnRaidEnd()
		{
			try
			{
				Reset();
				LogDebug("[BotSpawnWatcher] 🧹 Reset after raid.");
			}
			catch (Exception ex)
			{
				LogError("[BotSpawnWatcher] ❌ OnRaidEnd error: " + ex);
			}
		}

		/// <summary>
		/// Clears internal bot ID cache and state flags for reuse in next raid.
		/// </summary>
		public static void Reset()
		{
			SeenBotIds.Clear();
			_nextPollTime = -1f;
			_hasWarnedInvalid = false;

			try
			{
				LogDebug("[BotSpawnWatcher] 🔄 Reset complete.");
			}
			catch
			{
				// Safe ignore: logger might be disposed during shutdown.
			}
		}

		#endregion

		#region Tick

		/// <inheritdoc />
		public void Tick(float deltaTime)
		{
			try
			{
				if (!GameWorldHandler.IsHost || !GameWorldHandler.IsInitialized || !GameWorldHandler.IsReady() || !WorldInitState.IsInPhase(WorldPhase.WorldReady))
				{
					if (!_hasWarnedInvalid)
					{
						LogWarn("[BotSpawnWatcher] ⚠ Not ready or not host — polling deferred.");
						_hasWarnedInvalid = true;
					}

					return;
				}

				if (_hasWarnedInvalid)
				{
					LogDebug("[BotSpawnWatcher] ✅ Host world recovered — resuming.");
					_hasWarnedInvalid = false;
				}

				float now = Time.time;
				if (now < _nextPollTime)
				{
					return;
				}

				_nextPollTime = now + PollInterval;

				List<Player> players = GameWorldHandler.GetAllAlivePlayers();
				if (players == null || players.Count == 0)
				{
					return;
				}

				for (int i = 0; i < players.Count; i++)
				{
					Player player = players[i];
					if (!EFTPlayerUtil.IsValid(player) || !player.IsAI || player.gameObject == null)
					{
						continue;
					}

					// Never inject AIRefactored bot brain if global nav is disabled
					if (NavPointRegistry.AIRefactoredNavDisabled)
					{
						continue;
					}

					GameObject go = player.gameObject;
					int id = go.GetInstanceID();

					// Only inject if not already seen and not already has BotBrain.
					if (!SeenBotIds.Add(id))
					{
						continue;
					}

					if (go.GetComponent<BotBrain>() != null)
					{
						continue;
					}

					if (player.AIData == null || player.AIData.BotOwner == null)
					{
						continue;
					}

					try
					{
						BotBrainGuardian.Enforce(go);
						GameWorldHandler.TryAttachBotBrain(player.AIData.BotOwner);

						string name = player.Profile?.Info?.Nickname ?? player.ProfileId;
						LogDebug("[BotSpawnWatcher] ✅ Brain injected for bot: " + name);
					}
					catch (Exception ex)
					{
						LogError("[BotSpawnWatcher] ❌ Brain injection failed for bot: " + ex);
					}
				}
			}
			catch (Exception ex)
			{
				LogError("[BotSpawnWatcher] ❌ Tick error: " + ex);
			}
		}

		#endregion

		#region Integration

		/// <inheritdoc />
		public bool IsReady()
		{
			return WorldInitState.IsInPhase(WorldPhase.WorldReady);
		}

		/// <inheritdoc />
		public WorldPhase RequiredPhase()
		{
			return WorldPhase.WorldReady;
		}

		#endregion

		#region Log Helpers

		private static void LogDebug(string msg)
		{
			if (!FikaHeadlessDetector.IsHeadless)
				Logger.LogDebug(msg);
		}

		private static void LogWarn(string msg)
		{
			if (!FikaHeadlessDetector.IsHeadless)
				Logger.LogWarning(msg);
		}

		private static void LogError(string msg)
		{
			if (!FikaHeadlessDetector.IsHeadless)
				Logger.LogError(msg);
		}

		#endregion
	}
}
