// <auto-generated>
//   This file is part of AI-Refactored, an open-source project focused on realistic AI behavior in Escape from Tarkov.
//   Licensed under the MIT License. See LICENSE in the repository root for more information.
//
//   THIS FILE IS SYSTEMATICALLY MANAGED.
//   Bulletproof: All failures are locally contained, never break other subsystems, and always trigger fallback isolation.
//   See: AIRefactored “Bulletproof Fallback & Isolation Safety Rule Set” for audit compliance.
// </auto-generated>

namespace AIRefactored.Bootstrap
{
    using System;
    using System.Collections.Generic;
    using AIRefactored.AI.Core;
    using AIRefactored.AI.Hotspots;
    using AIRefactored.AI.Looting;
    using AIRefactored.AI.Navigation;
    using AIRefactored.AI.Optimization;
    using AIRefactored.AI.Threads;
    using AIRefactored.Core;
    using AIRefactored.Pools;
    using AIRefactored.Runtime;
    using BepInEx.Logging;
    using Comfort.Common;
    using EFT;
    using UnityEngine;

    /// <summary>
    /// Main coordinator for AIRefactored world systems. Handles initialization, tick/update, and teardown.
    /// Fully bulletproof: all errors are locally contained and never break the AIRefactored stack.
    /// </summary>
    public static class WorldBootstrapper
    {
        #region Fields

        private static readonly List<IAIWorldSystemBootstrapper> Systems = new List<IAIWorldSystemBootstrapper>(16);
        private static ManualLogSource _loggerInstance = Plugin.LoggerInstance;

        private static bool _hasInitialized;
        private static bool _hasShutdownLogged;
        private static float _lastSweep;
        private const float SweepInterval = 20f;

        private static ManualLogSource Logger => _loggerInstance ?? Plugin.LoggerInstance;

        #endregion

        #region Lifecycle

        /// <summary>
        /// Begins world system initialization. Does NOT register navmesh or navpoints.
        /// Bulletproof: all exceptions contained, never cascades or breaks global mod state.
        /// </summary>
        public static void Begin(ManualLogSource logger, string mapId)
        {
            _loggerInstance = logger ?? Plugin.LoggerInstance;

            if (_hasInitialized)
            {
                Logger.LogDebug("[WorldBootstrapper] Already initialized — skipping.");
                return;
            }

            try
            {
                _hasShutdownLogged = false;
                Systems.Clear();

                // Bulletproof global resets: never triggers navmesh/navpoint population here!
                TrySafe(BotRecoveryService.Reset, "[WorldBootstrapper] BotRecoveryService.Reset() failed: ");
                TrySafe(BotSpawnWatcherService.Reset, "[WorldBootstrapper] BotSpawnWatcherService.Reset() failed: ");
                TrySafe(LootRuntimeWatcher.Reset, "[WorldBootstrapper] LootRuntimeWatcher.Reset() failed: ");
                TrySafe(DeadBodyObserverService.Reset, "[WorldBootstrapper] DeadBodyObserverService.Reset() failed: ");
                TrySafe(DeadBodyContainerCache.Clear, "[WorldBootstrapper] DeadBodyContainerCache.Clear() failed: ");
                TrySafe(LootRegistry.Clear, "[WorldBootstrapper] LootRegistry.Clear() failed: ");
                TrySafe(HotspotRegistry.Clear, "[WorldBootstrapper] HotspotRegistry.Clear() failed: ");
                TrySafe(NavPointRegistry.Clear, "[WorldBootstrapper] NavPointRegistry.Clear() failed: ");

                // Only initialize HotspotRegistry if mapId is valid.
                if (!string.IsNullOrEmpty(mapId))
                {
                    TrySafe(() => HotspotRegistry.Initialize(mapId), "[WorldBootstrapper] HotspotRegistry.Initialize() failed: ");
                }
                else
                {
                    Logger.LogWarning("[WorldBootstrapper] Cannot initialize registries — mapId is invalid.");
                }

                // Register world systems (do not add navmesh/navpoint managers here)
                RegisterSystemSafe(new RaidLifecycleWatcher());
                RegisterSystemSafe(new BotRecoveryService());
                RegisterSystemSafe(new BotSpawnWatcherService());
                RegisterSystemSafe(new LootRuntimeWatcher());
                RegisterSystemSafe(new DeadBodyObserverService());
                RegisterSystemSafe(new HotspotRegistryBootstrapper());

                // Initialize all systems (never break loop on single error)
                for (int i = 0; i < Systems.Count; i++)
                {
                    IAIWorldSystemBootstrapper sys = Systems[i];
                    TrySafe(sys.Initialize, $"[WorldBootstrapper] Failed to initialize {sys.GetType().Name}: ");
                }

                _hasInitialized = true;
                Logger.LogDebug("[WorldBootstrapper] ✅ World systems initialized.");
            }
            catch (Exception ex)
            {
                Logger.LogError("[WorldBootstrapper] Initialization failed: " + ex);
            }
        }

        /// <summary>
        /// Stops and tears down world systems. Does not touch navmesh/navpoint state.
        /// </summary>
        public static void Stop()
        {
            if (!_hasInitialized) return;

            try
            {
                for (int i = 0; i < Systems.Count; i++)
                {
                    IAIWorldSystemBootstrapper sys = Systems[i];
                    TrySafe(sys.OnRaidEnd, $"[WorldBootstrapper] OnRaidEnd error in {sys.GetType().Name}: ");
                }

                Systems.Clear();
                _hasInitialized = false;

                if (!_hasShutdownLogged)
                {
                    _hasShutdownLogged = true;
                    Logger.LogDebug("[WorldBootstrapper] 🔻 AIRefactored systems shut down.");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError("[WorldBootstrapper] Stop() encountered error: " + ex);
            }
        }

        #endregion

        #region Tick

        /// <summary>
        /// Ticks all registered world systems and attached BotBrains (per frame/tick).
        /// Bulletproof: all tick errors are contained and never propagate.
        /// </summary>
        public static void Tick(float deltaTime)
        {
            if (!_hasInitialized)
                return;

            try
            {
                float now = Time.time;

                for (int i = 0; i < Systems.Count; i++)
                {
                    IAIWorldSystemBootstrapper system = Systems[i];
                    if (system == null) continue;

                    try
                    {
                        if (WorldInitState.IsInPhase(system.RequiredPhase()))
                        {
                            system.Tick(deltaTime);
                        }
                    }
                    catch (Exception ex)
                    {
                        Logger.LogError("[WorldBootstrapper] System Tick() error in " + system.GetType().Name + ": " + ex);
                    }
                }

                List<Player> players = GameWorldHandler.GetAllAlivePlayers();
                try
                {
                    for (int i = 0; i < players.Count; i++)
                    {
                        Player player = players[i];
                        if (!EFTPlayerUtil.IsValid(player) || !player.IsAI) continue;

                        GameObject go = player.gameObject;
                        if (go == null) continue;

                        BotBrain brain = go.GetComponent<BotBrain>();
                        if (brain != null && brain.enabled)
                        {
                            try { brain.Tick(deltaTime); }
                            catch (Exception ex) { Logger.LogError("[WorldBootstrapper] BotBrain.Tick() error: " + ex); }
                        }
                    }
                }
                finally
                {
                    TempListPool.Return(players);
                }

                if (now - _lastSweep >= SweepInterval)
                {
                    _lastSweep = now;
                    TrySafe(GameWorldHandler.EnforceBotBrains, "[WorldBootstrapper] EnforceBotBrains() failed: ");
                    TrySafe(GameWorldHandler.CleanupDeadBotsSmoothly, "[WorldBootstrapper] CleanupDeadBotsSmoothly() failed: ");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError("[WorldBootstrapper] Tick() outer error: " + ex);
            }
        }

        #endregion

        #region BotBrain Injection

        /// <summary>
        /// Ensures the given player has a BotBrain attached and initialized.
        /// </summary>
        public static void EnforceBotBrain(Player player, BotOwner bot)
        {
            if (!EFTPlayerUtil.IsValid(player) || !player.IsAI) return;

            GameObject go = player.gameObject;
            if (go == null) return;

            try
            {
                BotBrainGuardian.Enforce(go);

                BotBrain existing = go.GetComponent<BotBrain>();
                if (existing == null && bot != null)
                {
                    BotBrain brain = go.AddComponent<BotBrain>();
                    brain.enabled = true;
                    brain.Initialize(bot);
                }
                else if (existing != null && !existing.enabled)
                {
                    existing.enabled = true;
                    Logger.LogWarning("[WorldBootstrapper] Re-enabled BotBrain for: " + player.ProfileId);
                }
            }
            catch (Exception ex)
            {
                Logger.LogWarning("[WorldBootstrapper] BotBrain init failed for " + player.ProfileId + ": " + ex);
            }
        }

        #endregion

        #region System Registration

        private static void RegisterSystemSafe(IAIWorldSystemBootstrapper system)
        {
            try
            {
                if (system == null || Systems.Contains(system)) return;
                Systems.Add(system);
            }
            catch (Exception ex)
            {
                Logger.LogError("[WorldBootstrapper] RegisterSystemSafe() failed: " + ex);
            }
        }

        public static void RegisterSystem(IAIWorldSystemBootstrapper system)
        {
            RegisterSystemSafe(system);
        }

        #endregion

        #region Helpers

        private static void TrySafe(Action action, string errorPrefix)
        {
            try { action(); }
            catch (Exception ex) { Logger.LogError(errorPrefix + ex); }
        }

        #endregion
    }
}
