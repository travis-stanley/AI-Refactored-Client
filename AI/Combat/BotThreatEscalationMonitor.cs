// <auto-generated>
//   This file is part of AI-Refactored, an open-source project focused on realistic AI behavior in Escape from Tarkov.
//   Licensed under the MIT License. See LICENSE in the repository root for more information.
//
//   THIS FILE IS SYSTEMATICALLY MANAGED.
//   All fallback/disable logic removed: Escalation always proceeds, all errors log only, never disables bot.
// </auto-generated>

namespace AIRefactored.AI.Combat
{
    using System;
    using AIRefactored.AI.Core;
    using AIRefactored.AI.Helpers;
    using AIRefactored.AI.Navigation;
    using AIRefactored.AI.Optimization;
    using AIRefactored.Core;
    using AIRefactored.Runtime;
    using BepInEx.Logging;
    using EFT;
    using UnityEngine;

    /// <summary>
    /// Monitors panic duration, enemy presence, and squad casualties.
    /// Escalates bot aggression and perception settings for realism under extreme threat.
    /// All logic is bulletproof, headless-safe, and never disables itself or any bot.
    /// </summary>
    public sealed class BotThreatEscalationMonitor
    {
        private const float CheckInterval = 1.0f;
        private const float PanicDurationThreshold = 4.0f;
        private const float SquadCasualtyThreshold = 0.4f;

        private static readonly ManualLogSource Logger = Plugin.LoggerInstance;

        private BotOwner _bot;
        private float _panicStartTime = -1f;
        private float _nextCheckTime = -1f;
        private float _lastVoiceTime = -1f;
        private bool _hasEscalated;

        public void Initialize(BotOwner botOwner)
        {
            if (botOwner == null)
            {
                Logger.LogError("[BotThreatEscalationMonitor] BotOwner is null in Initialize.");
                return;
            }

            _bot = botOwner;
            _panicStartTime = -1f;
            _nextCheckTime = -1f;
            _lastVoiceTime = -1f;
            _hasEscalated = false;
        }

        public void NotifyPanicTriggered()
        {
            if (_panicStartTime < 0f)
            {
                _panicStartTime = Time.time;
            }
        }

        public void Tick(float time)
        {
            if (_hasEscalated || !IsValid() || time < _nextCheckTime)
                return;

            try
            {
                _nextCheckTime = time + CheckInterval;

                if (ShouldEscalate(time))
                {
                    EscalateBot(time);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError("[BotThreatEscalationMonitor] Tick exception: " + ex);
            }
        }

        #region Escalation Conditions

        private bool ShouldEscalate(float time)
        {
            try
            {
                return PanicDurationExceeded(time) || MultipleEnemiesVisible() || SquadHasLostTeammates();
            }
            catch (Exception ex)
            {
                Logger.LogError("[BotThreatEscalationMonitor] ShouldEscalate exception: " + ex);
                return false;
            }
        }

        private bool PanicDurationExceeded(float time)
        {
            return _panicStartTime >= 0f && (time - _panicStartTime) > PanicDurationThreshold;
        }

        private bool MultipleEnemiesVisible()
        {
            try
            {
                var controller = _bot.EnemiesController;
                if (controller?.EnemyInfos == null)
                    return false;

                int visible = 0;
                foreach (var kv in controller.EnemyInfos)
                {
                    if (kv.Value?.IsVisible == true && ++visible >= 2)
                        return true;
                }

                return false;
            }
            catch (Exception ex)
            {
                Logger.LogError("[BotThreatEscalationMonitor] MultipleEnemiesVisible exception: " + ex);
                return false;
            }
        }

        private bool SquadHasLostTeammates()
        {
            try
            {
                var group = _bot.BotsGroup;
                if (group == null || group.MembersCount <= 1)
                    return false;

                int dead = 0;
                for (int i = 0; i < group.MembersCount; i++)
                {
                    if (group.Member(i)?.IsDead == true)
                        dead++;
                }

                return dead >= Mathf.CeilToInt(group.MembersCount * SquadCasualtyThreshold);
            }
            catch (Exception ex)
            {
                Logger.LogError("[BotThreatEscalationMonitor] SquadHasLostTeammates exception: " + ex);
                return false;
            }
        }

        #endregion

        #region Escalation Logic

        private void EscalateBot(float time)
        {
            try
            {
                _hasEscalated = true;

                string name = _bot.Profile?.Info?.Nickname ?? "Unknown";
                Logger.LogDebug($"[AIRefactored-Escalation] Escalating bot '{name}'");

                AIOptimizationManager.Reset(_bot);
                AIOptimizationManager.Apply(_bot);

                ApplyEscalationTuning(_bot);
                ApplyPersonalityTuning(_bot);

                // Squad-aware repositioning (via helpers only, never GoToPoint direct)
                if (BotNavHelper.TryGetSafeTarget(_bot, out var navTarget) && IsVectorValid(navTarget))
                {
                    if (_bot.Mover != null && !_bot.Mover.IsMoving)
                    {
                        float cohesion = BotRegistry.Get(_bot.ProfileId)?.Cohesion ?? 1.0f;
                        BotMovementHelper.SmoothMoveTo(_bot, navTarget, false, cohesion);
                        Logger.LogDebug($"[AIRefactored-Escalation] '{name}' repositioned to cover (helper).");
                    }
                }

                if (!FikaHeadlessDetector.IsHeadless &&
                    _bot.BotTalk != null &&
                    time - _lastVoiceTime > 2.5f)
                {
                    try { _bot.BotTalk.TrySay(EPhraseTrigger.OnFight); }
                    catch { }

                    _lastVoiceTime = time;
                }
            }
            catch (Exception ex)
            {
                Logger.LogError("[BotThreatEscalationMonitor] EscalateBot exception: " + ex);
            }
        }

        private void ApplyEscalationTuning(BotOwner bot)
        {
            try
            {
                var file = bot?.Settings?.FileSettings;
                if (file == null) return;

                file.Shoot.RECOIL_PER_METER = Mathf.Clamp(file.Shoot.RECOIL_PER_METER * 0.82f, 0.1f, 2.0f);
                file.Mind.DIST_TO_FOUND_SQRT = Mathf.Clamp(file.Mind.DIST_TO_FOUND_SQRT * 1.23f, 200f, 900f);
                file.Mind.ENEMY_LOOK_AT_ME_ANG = Mathf.Clamp(file.Mind.ENEMY_LOOK_AT_ME_ANG * 0.7f, 4f, 45f);
                file.Mind.CHANCE_TO_RUN_CAUSE_DAMAGE_0_100 = Mathf.Clamp(file.Mind.CHANCE_TO_RUN_CAUSE_DAMAGE_0_100 + 28f, 0f, 100f);
                file.Look.MAX_VISION_GRASS_METERS = Mathf.Clamp(file.Look.MAX_VISION_GRASS_METERS + 7f, 5f, 42f);

                Logger.LogDebug($"[AIRefactored-Tuning] Escalation tuning applied to '{bot.Profile?.Info?.Nickname ?? "Unknown"}'");
            }
            catch (Exception ex)
            {
                Logger.LogError("[BotThreatEscalationMonitor] Escalation tuning failed: " + ex);
            }
        }

        private void ApplyPersonalityTuning(BotOwner bot)
        {
            try
            {
                var profile = BotRegistry.Get(bot.ProfileId);
                if (profile == null)
                    return;

                profile.AggressionLevel = Mathf.Clamp01(profile.AggressionLevel + 0.25f);
                profile.Caution = Mathf.Clamp01(profile.Caution - 0.23f);
                profile.SuppressionSensitivity = Mathf.Clamp01(profile.SuppressionSensitivity * 0.7f);
                profile.AccuracyUnderFire = Mathf.Clamp01(profile.AccuracyUnderFire + 0.22f);
                profile.CommunicationLevel = Mathf.Clamp01(profile.CommunicationLevel + 0.22f);

                Logger.LogDebug(
                    $"[AIRefactored-Tuning] Personality tuned for '{bot.Profile?.Info?.Nickname ?? "Unknown"}': " +
                    $"Agg={profile.AggressionLevel:F2}, " +
                    $"Caution={profile.Caution:F2}, " +
                    $"Supp={profile.SuppressionSensitivity:F2}, " +
                    $"AccUF={profile.AccuracyUnderFire:F2}");
            }
            catch (Exception ex)
            {
                Logger.LogError("[BotThreatEscalationMonitor] Personality tuning failed: " + ex);
            }
        }

        #endregion

        #region Validation

        private bool IsValid()
        {
            try
            {
                return _bot != null &&
                       !_bot.IsDead &&
                       _bot.GetPlayer is Player player &&
                       player.IsAI;
            }
            catch
            {
                return false;
            }
        }

        private static bool IsVectorValid(Vector3 v)
        {
            return !float.IsNaN(v.x) && !float.IsNaN(v.y) && !float.IsNaN(v.z);
        }

        #endregion
    }
}
